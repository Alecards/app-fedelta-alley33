<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alley33 Card</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #16a34a; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #welcome-view-bg {
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg min-h-screen relative">
        <div id="loading-view" class="flex items-center justify-center min-h-screen"><div class="loader"></div></div>
        <div id="welcome-view" class="relative h-screen overflow-hidden hidden">
            <div id="welcome-view-bg" class="absolute top-0 left-0 w-full h-full"></div>
            <div class="relative z-20 flex flex-col justify-between h-full p-8 text-white">
                <div class="text-center"><img id="welcome-logo" src="./Logo_Alley_bianco.png" alt="Logo Alley33" class="w-48 mx-auto"></div>
                <div class="text-center"><h1 class="text-4xl font-extrabold">Benvenuto</h1><p class="mt-2">La tua fidelity card, sempre con te.</p></div>
                <div class="space-y-4">
                    <button id="install-pwa-button" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 hidden">Installa App</button>
                    <button id="go-to-register-button" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200">Sei un nuovo utente? Registrati</button>
                    <button id="go-to-login-button" class="w-full bg-transparent border border-white text-white font-bold py-3 rounded-lg hover:bg-white hover:text-black">Sei già registrato? Accedi</button>
                </div>
            </div>
        </div>
        <div id="login-view" class="p-8 hidden">
            <div class="text-center mb-8"><img class="page-logo w-32 mx-auto mb-4" src="./Logo_Alley_nero.png" alt="Logo Alley33"><h1 class="text-3xl font-bold text-gray-800">Accedi</h1></div>
            <div class="space-y-4"><input type="email" id="login-email-input" placeholder="Email" class="w-full px-4 py-3 border rounded-lg"><input type="password" id="login-password-input" placeholder="Password" class="w-full px-4 py-3 border rounded-lg"><button id="login-button" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Entra</button></div>
            <a href="#" id="go-to-recover-button" class="block text-center text-sm text-green-600 mt-4 hover:underline">Password dimenticata?</a>
            <p id="login-error-message" class="text-red-600 text-sm mt-4 text-center hidden"></p>
            <button class="back-to-welcome text-gray-500 text-sm mt-8 mx-auto block"> &larr; Torna alla home</button>
        </div>
        <div id="register-view" class="p-8 hidden">
             <div class="text-center mb-8"><img class="page-logo w-32 mx-auto mb-4" src="./Logo_Alley_nero.png" alt="Logo Alley33"><h1 class="text-3xl font-bold text-gray-800">Crea il tuo account</h1></div>
            <div class="space-y-4"><input type="text" id="register-name-input" placeholder="Nome" class="w-full px-4 py-3 border rounded-lg"><input type="text" id="register-surname-input" placeholder="Cognome" class="w-full px-4 py-3 border rounded-lg"><input type="email" id="register-email-input" placeholder="Email" class="w-full px-4 py-3 border rounded-lg"><input type="tel" id="register-phone-input" placeholder="Cellulare" class="w-full px-4 py-3 border rounded-lg"><input type="password" id="register-password-input" placeholder="Password (min. 6 caratteri)" class="w-full px-4 py-3 border rounded-lg"><div class="space-y-3 pt-2"><div class="flex items-start"><input id="privacy-check" type="checkbox" class="h-5 w-5 mt-0.5 text-green-600 focus:ring-green-500"><label for="privacy-check" class="ml-3 text-sm">Dichiaro di aver letto la <a href="#" id="open-privacy-policy" class="font-semibold text-green-600">Privacy Policy</a>.</label></div><div class="flex items-start"><input id="marketing-check" type="checkbox" class="h-5 w-5 mt-0.5 text-green-600 focus:ring-green-500"><label for="marketing-check" class="ml-3 text-sm">Acconsento al marketing.</label></div></div><button id="register-button" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg !mt-6 hover:bg-green-700">Registrati</button></div>
            <p id="register-error-message" class="text-red-600 text-sm mt-4 text-center hidden"></p>
            <button class="back-to-welcome text-gray-500 text-sm mt-8 mx-auto block"> &larr; Torna alla home</button>
        </div>
        <div id="recover-password-view" class="p-8 hidden">
            <div class="text-center mb-8"><img class="page-logo w-32 mx-auto mb-4" src="./Logo_Alley_nero.png" alt="Logo Alley33"><h1 class="text-3xl font-bold text-gray-800">Recupera Password</h1></div>
            <p class="text-gray-600 mb-4 text-center">Inserisci la tua email e ti invieremo un link per reimpostare la password.</p>
            <div class="space-y-4"><input type="email" id="recover-email-input" placeholder="La tua email di registrazione" class="w-full px-4 py-3 border rounded-lg"><button id="recover-button" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Invia link</button></div>
            <p id="recover-message" class="text-green-600 text-sm mt-4 text-center hidden"></p>
            <button class="back-to-welcome text-gray-500 text-sm mt-8 mx-auto block"> &larr; Torna alla home</button>
        </div>
        <div id="main-app-view" class="hidden">
            <header class="bg-white text-gray-800 p-4 flex justify-between items-center border-b"><div id="welcome-message-container"></div><img class="page-logo h-8" src="./Logo_Alley_nero.png" alt="Logo Alley33"></header>
            <main id="main-content" class="p-4 pb-20"></main>
            <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t flex justify-around"></nav>
        </div>
        <template id="card-template"><div class="bg-gray-900 text-white rounded-xl shadow-2xl p-6 text-center"><h3 class="text-2xl font-semibold">Punti Fedeltà</h3><p id="points-display" class="text-7xl font-bold my-4">0</p><p class="text-gray-400">Il tuo barcode personale</p><div class="bg-white p-4 rounded-lg mt-4"><svg id="barcode"></svg></div></div><div class="mt-6"><h4 class="text-xl font-bold text-gray-800 mb-3">Storico Transazioni</h4><ul id="history-list" class="space-y-3"></ul><button id="logout-button-main" class="w-full mt-8 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700">Esci</button></div></template>
        <template id="shop-template"><div class="text-center pt-16"><h3 class="text-2xl font-bold text-gray-800 mb-4">Visita il nostro Shop Online</h3><p class="text-gray-600 mb-8 max-w-xs mx-auto">Clicca per aprire il sito in una nuova pagina.</p><a href="https://www.alley33.it" target="_blank" class="inline-block bg-green-600 text-white font-bold py-4 px-10 rounded-lg shadow-md hover:bg-green-700">Vai ad Alley33.it</a></div></template>
        <div id="privacy-modal" class="modal-overlay hidden"><div class="bg-white rounded-lg shadow-xl m-6 max-w-lg w-full max-h-[80vh] overflow-y-auto"><div class="p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">Informativa Privacy</h3><button id="close-privacy-policy" class="text-gray-500">&times;</button></div><div id="privacy-content" class="prose prose-sm"></div></div></div></div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "...", // INSERISCI QUI LE TUE NUOVE CHIAVI
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const allViews = { loading: document.getElementById('loading-view'), welcome: document.getElementById('welcome-view'), login: document.getElementById('login-view'), register: document.getElementById('register-view'), recover: document.getElementById('recover-password-view'), main: document.getElementById('main-app-view') };
        function showView(viewName) { Object.values(allViews).forEach(v => v.classList.add('hidden')); if(allViews[viewName]) allViews[viewName].classList.remove('hidden'); }
        
        async function loadAndApplySettings() {
            const settingsRef = doc(db, "settings", "appConfig");
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const settings = docSnap.data();
                if (settings.logoBiancoUrl) document.getElementById('welcome-logo').src = settings.logoBiancoUrl;
                if (settings.logoNeroUrl) document.querySelectorAll('.page-logo').forEach(img => img.src = settings.logoNeroUrl);
                if (settings.privacyPolicy) document.getElementById('privacy-content').innerHTML = settings.privacyPolicy.replace(/\n/g, '<br>');
            }
        }
        
        document.getElementById('go-to-register-button').addEventListener('click', () => showView('register'));
        document.getElementById('go-to-login-button').addEventListener('click', () => showView('login'));
        document.getElementById('go-to-recover-button').addEventListener('click', (e) => { e.preventDefault(); showView('recover'); });
        document.querySelectorAll('.back-to-welcome').forEach(btn => btn.addEventListener('click', () => showView('welcome')));
        
        const loginEmailInput = document.getElementById('login-email-input');
        const loginPasswordInput = document.getElementById('login-password-input');
        const loginButton = document.getElementById('login-button');
        const loginErrorMessage = document.getElementById('login-error-message');
        async function handleLogin() { /* ... */ }
        loginButton.addEventListener('click', handleLogin);

        const registerNameInput = document.getElementById('register-name-input');
        const registerSurnameInput = document.getElementById('register-surname-input');
        const registerEmailInput = document.getElementById('register-email-input');
        const registerPhoneInput = document.getElementById('register-phone-input');
        const registerPasswordInput = document.getElementById('register-password-input');
        const privacyCheck = document.getElementById('privacy-check');
        const marketingCheck = document.getElementById('marketing-check');
        const registerButton = document.getElementById('register-button');
        const registerErrorMessage = document.getElementById('register-error-message');
        async function handleRegister() { /* ... */ }
        registerButton.addEventListener('click', handleRegister);

        const recoverEmailInput = document.getElementById('recover-email-input');
        const recoverButton = document.getElementById('recover-button');
        const recoverMessage = document.getElementById('recover-message');
        async function handlePasswordRecovery() { /* ... */ }
        recoverButton.addEventListener('click', handlePasswordRecovery);

        const mainContent = document.getElementById('main-content');
        const navContainer = document.querySelector('nav');
        let unsubscribeFromFirestore = null;
        function handleLogout() { if (unsubscribeFromFirestore) unsubscribeFromFirestore(); signOut(auth); }
        function renderApp(userData) { /* ... */ }
        function setupNavigation() { /* ... */ }

        onAuthStateChanged(auth, async (user) => {
            await loadAndApplySettings();
            if (user) {
                if (unsubscribeFromFirestore) unsubscribeFromFirestore();
                unsubscribeFromFirestore = onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) { showView('main'); renderApp(docSnap.data()); setupNavigation(); } 
                    else { handleLogout(); }
                });
            } else { showView('welcome'); }
        });

        function generateEan13() { /* ... */ }
        const privacyModal = document.getElementById('privacy-modal');
        const openPrivacyBtn = document.getElementById('open-privacy-policy');
        const closePrivacyBtn = document.getElementById('close-privacy-policy');
        openPrivacyBtn.addEventListener('click', (e) => { e.preventDefault(); privacyModal.classList.remove('hidden'); });
        closePrivacyBtn.addEventListener('click', () => privacyModal.classList.add('hidden'));
        privacyModal.addEventListener('click', (e) => { if (e.target === privacyModal) privacyModal.classList.add('hidden'); });
    
        let deferredPrompt;
        const installButton = document.getElementById('install-pwa-button');
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installButton.classList.remove('hidden'); });
        installButton.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installButton.classList.add('hidden'); } });
        window.addEventListener('appinstalled', () => { deferredPrompt = null; installButton.classList.add('hidden'); });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
    </script>
</body>
</html>
